{% extends "base.html" %}
{% block content %}

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
.card { border-radius: 12px; }

/* Hide fallback background */
.plyr__video-embed { background:#000; }

/* Disable clicking inside YouTube iframe (prevents redirect / copy link) */
#plyrContainer iframe {
    pointer-events: none !important;
}

/* Modal body styling */
.modal-body.p-0 { padding:0; background:#000; }
</style>

<div class="content container-fluid">
  <div class="page-header">
    <div class="row">
      <div class="col-sm-12"><h3 class="page-title">Content</h3></div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg p-4">
        <h4 class="text-center mb-4">Content List</h4>

        {% if contents %}
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>Code</th>
              <th>Title</th>
              <th>Type</th>
              <th>Category</th>
              <th>Play</th>
            </tr>
          </thead>
          <tbody>
            {% for c in contents %}
            <tr>
              <td>{{ c.content_code }}</td>
              <td>{{ c.content_title }}</td>

              <td>
                {% if c.content_type == 1 %} Audio
                {% elif c.content_type == 2 %} Video
                {% elif c.content_type == 3 %} PDF
                {% elif c.content_type == 4 %} Image
                {% else %} - {% endif %}
              </td>

              <td>
                {% if c.content_category == 1 %} Poem
                {% elif c.content_category == 2 %} Story
                {% elif c.content_category == 3 %} Other
                {% else %} - {% endif %}
              </td>

              <td>
                {% if c.embed_id %}
                  <button class="btn btn-primary btn-sm"
                          onclick="openPlyrModal('{{ c.embed_id }}')">
                    Play Video
                  </button>
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-center text-muted">No content available.</p>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="videoModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-0">

        <!-- Plyr container -->
        <div id="plyrContainer">
          <div id="plyrPlayer" data-plyr-provider="youtube" data-plyr-embed-id=""></div>
        </div>

        <!-- Restricted video fallback -->
        <div id="embedError" style="display:none; padding:20px; background:#c62828; color:white;">
          <p>This video cannot be played here. The uploader has blocked embedding.</p>
          <button id="openYoutubeBtn" class="btn btn-light btn-sm">Open on YouTube</button>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
let plyrPlayer = null;
let currentVideoId = null;

function openPlyrModal(videoId) {
  currentVideoId = videoId;

  document.getElementById('embedError').style.display = 'none';
  document.getElementById('plyrContainer').style.display = 'block';

  const modal = new bootstrap.Modal(document.getElementById('videoModal'));
  modal.show();

  setTimeout(initPlyr, 150);
}

function initPlyr() {
  if (plyrPlayer) plyrPlayer.destroy();

  const container = document.getElementById('plyrContainer');
  container.innerHTML = `
    <div class="plyr__video-embed" id="plyrEmbed">
      <iframe
        src="https://www.youtube-nocookie.com/embed/${currentVideoId}?controls=0&modestbranding=1&showinfo=0&rel=0&iv_load_policy=3&disablekb=1&playsinline=1&fs=0&enablejsapi=1&origin=${window.location.origin}"
        allow="autoplay; encrypted-media"
        allowfullscreen
        data-plyr-provider="youtube"
        data-plyr-embed-id="${currentVideoId}">
      </iframe>
    </div>
  `;

  /* ------------------------------------------------------------------
     Updated: Enabled Q̲U̲A̲L̲I̲T̲Y̲  O̲P̲T̲I̲O̲N̲S̲  + SPEED
     ------------------------------------------------------------------ */
  plyrPlayer = new Plyr('#plyrEmbed', {
    controls: [
      'play',
      'progress',
      'current-time',
      'mute',
      'volume',
      'settings'
    ],

    settings: ['quality', 'speed'],

    speed: {
      selected: 1,
      options: [0.5, 0.75, 1, 1.25, 1.5, 2]
    },

    /* Quality options (Plyr simulated menu for YouTube) */
    quality: {
      default: 1080,
      options: [144, 240, 360, 480, 720, 1080],
      forced: true,           // force Plyr to use our menu
      onChange: (quality) => {
        try {
          let iframe = document.querySelector('#plyrEmbed iframe');
          let player = iframe.contentWindow;

          // Send JS API command to YouTube
          player.postMessage(JSON.stringify({
            event: "command",
            func: "setPlaybackQuality",
            args: [quality + "p"]
          }), "*");
        } catch (e) {
          console.warn("Quality change not supported by YouTube embed.");
        }
      }
    },

    youtube: { noCookie: true }
  });

  plyrPlayer.on('error', () => handleEmbedError());
}

function handleEmbedError() {
  document.getElementById('plyrContainer').style.display = 'none';
  document.getElementById('embedError').style.display = 'block';

  document.getElementById('openYoutubeBtn').onclick = function () {
    window.open("https://www.youtube.com/watch?v=" + currentVideoId, "_blank");
  };
}

document.getElementById('videoModal').addEventListener('hidden.bs.modal', () => {
  if (plyrPlayer) plyrPlayer.destroy();
  plyrPlayer = null;
});
</script>


{% endblock content %}
