<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ video_title }}</title>

<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

<style>
/* NAVBAR */
.navbar {
    width: 100%;
    background: #48408C;
    padding: 30px 0;         
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;

    display: flex;
    justify-content: center; /* CENTER CONTENT */
    align-items: center;     /* Vertical center */
    text-align: center;
}

.navbar h2 {
    margin: 0;
    padding: 0;
    color: #fff;
    font-size: 50px;
    font-weight: bold;
}

/* Page background */
html, body {
    background: #ffffffff !important;
    margin: 70px 0 0 0;  
    padding: 0;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
}

/* Title */
.video-title {
    font-size: 40px;
    font-weight: bold;
    padding: 10px 10px;
    color: #000000ff;
    margin-top: 10px; /* Extra space due to navbar */
}

/* Video wrapper */
#playerWrapper {
    max-width: 900px;
    margin: 40px auto 0 auto;
    padding: 10px;
}

/* Player box background */
#plyrContainer,
.plyr,
.plyr__video-wrapper,
.plyr__video-embed {
    background: #000 !important;
    border-radius: 5px;
}

/* iframe background fix */
iframe {
    background: #000 !important;
}

/* Disable click inside iframe */
#plyrContainer iframe {
    pointer-events: none !important;
}

/* Error box */
#embedError {
    background: #b71c1c;
    color: #fff;
    border-radius: 8px;
}

/* Button inside error box */
#openYoutubeBtn {
    background: #262626;
    color: #fff;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
#openYoutubeBtn:hover {
    background: #333;
}

/* Hide player if token invalid */
{% if invalid %}
#playerWrapper {
    display: none !important;
}
{% endif %}
</style>

</head>

<body>

<!-- TOP NAVBAR -->
<div class="navbar">
    <h2>Brainstorm LMS</h2>
</div>

<!-- Title -->
<div class="video-title">{{ video_title }}</div>

<!-- Video Area -->
<div id="playerWrapper">
    <div id="plyrContainer">
        <div id="plyrPlayer"
             data-plyr-provider="youtube"
             data-plyr-embed-id="{{ embed_id }}">
        </div>
    </div>

    <div id="embedError" style="display:none; padding:20px;">
        <p>This video cannot be played here. The uploader has blocked embedding.</p>
        <button id="openYoutubeBtn">Open on YouTube</button>
    </div>
</div>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
let plyrPlayer = null;
let currentVideoId = "{{ embed_id }}";

document.addEventListener("DOMContentLoaded", function () {
    // Only init Plyr if embed_id exists
    if(currentVideoId) {
        initPlyr();
    }
});

function initPlyr() {
    if (plyrPlayer) plyrPlayer.destroy();

    const container = document.getElementById('plyrContainer');
    container.innerHTML = `
        <div class="plyr__video-embed" id="plyrEmbed">
            <iframe
              src="https://www.youtube-nocookie.com/embed/${currentVideoId}?autoplay=1&controls=0&modestbranding=1&showinfo=0&rel=0&iv_load_policy=3&disablekb=1&playsinline=1&fs=0&enablejsapi=1&origin=${window.location.origin}"
              allow="autoplay; fullscreen; encrypted-media"
              allowfullscreen>
            </iframe>
        </div>
    `;

    plyrPlayer = new Plyr('#plyrEmbed', {
        controls: [
          'play','progress','current-time','mute','volume','settings','fullscreen'
        ],
        settings: ['quality','speed'],
        speed: { options: [0.5,0.75,1,1.25,1.5,2] },
        quality: {
            default: 1080,
            options: [144,240,360,480,720,1080],
            forced: true,
            onChange: (q)=> {
                try {
                    let iframe = document.querySelector('#plyrEmbed iframe');
                    iframe.contentWindow.postMessage(JSON.stringify({
                        event: "command",
                        func: "setPlaybackQuality",
                        args: [q + "p"]
                    }), "*");
                } catch (e) {}
            }
        }
    });

    plyrPlayer.on('error', () => handleEmbedError());
}

function handleEmbedError() {
    document.getElementById('plyrContainer').style.display = 'none';
    document.getElementById('embedError').style.display = 'block';

    document.getElementById('openYoutubeBtn').onclick = function () {
        window.open("https://www.youtube.com/watch?v=" + currentVideoId, "_blank");
    };
}
</script>

</body>
</html>
